<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.hospitalserver.mapper.HospitalDepartmentMapper">

    <select id="getDepartmentPageList"
            parameterType="com.hospital.hospitalserver.domain.dto.request.HospitalGetDepartmentPageReqDtp"
            resultType="com.hospital.hospitalserver.domain.dto.response.HospitalGetDepartmentPageRespDto">
        SELECT
        d.id,
        d.name,
        d.code,
        d.description,
        d.dc_id AS dcId,
        d.doctor_id AS doctorId,
        dd.name AS doctorName,
        d.phone,
        d.created_at AS createdAt,
        d.updated_at AS updatedAt,
        d.established_time AS establishedTime,
        d.status,
        COALESCE(dc_count.doctorCount, 0) AS doctorCount,
        COALESCE(cr_count.clinicRoomCount, 0) AS clinicRoomCount
        FROM hospital.h_department_tb d
        LEFT JOIN hospital.h_doctor_tb dd ON d.doctor_id = dd.id
        LEFT JOIN hospital.h_department_class_tb dc ON dc.id = d.dc_id
        -- 子查询：统计每个科室的医生数量
        LEFT JOIN (
        SELECT
        d.id as id,
        COUNT(dd.id) AS doctorCount
        FROM hospital.h_department_tb d
        LEFT JOIN hospital.h_clinic_room_tb cc ON cc.department_id = d.id
        LEFT JOIN hospital.h_clinic_room_doctor_tb ccd ON ccd.clinic_room_id = cc.id
        LEFT JOIN hospital.h_doctor_tb dd ON dd.id = ccd.doctor_id
        GROUP BY d.id
        ) dc_count ON dc_count.id = d.id
        -- 子查询：统计每个科室的诊室数量
        LEFT JOIN (
        SELECT
        department_id as id,
        COUNT(id) AS clinicRoomCount
        FROM hospital.h_clinic_room_tb
        GROUP BY department_id
        ) cr_count ON cr_count.id = d.id
        <where>
            <if test="name != null">
                AND d.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="code != null">
                AND d.code = #{code}
            </if>
            <if test="doctorName != null">
                AND dd.name LIKE CONCAT('%', #{doctorName}, '%')
            </if>
            <if test="dcId != null">
                AND dc.id = #{dcId}
            </if>
            <if test="status != null">
                AND d.status = #{status}
            </if>
        </where>
        ORDER BY d.id  -- 建议加上 ORDER BY
        LIMIT #{start}, #{size}
    </select>

    <select id="getDepartmentPageListCount" resultType="java.lang.Integer">
        select
        count(d.id)
        FROM hospital.h_department_tb d
        LEFT JOIN hospital.h_doctor_tb dd ON d.doctor_id = dd.id
        LEFT JOIN hospital.h_department_class_tb dc ON dc.id = d.dc_id
        -- 子查询：统计每个科室的医生数量
        LEFT JOIN (
        SELECT
        d.id as id,
        COUNT(dd.id) AS doctorCount
        FROM hospital.h_department_tb d
        LEFT JOIN hospital.h_clinic_room_tb cc ON cc.department_id = d.id
        LEFT JOIN hospital.h_clinic_room_doctor_tb ccd ON ccd.clinic_room_id = cc.id
        LEFT JOIN hospital.h_doctor_tb dd ON dd.id = ccd.doctor_id
        GROUP BY d.id
        ) dc_count ON dc_count.id = d.id
        -- 子查询：统计每个科室的诊室数量
        LEFT JOIN (
        SELECT
        department_id as id,
        COUNT(id) AS clinicRoomCount
        FROM hospital.h_clinic_room_tb
        GROUP BY department_id
        ) cr_count ON cr_count.id = d.id
        <where>
            <if test="name != null">
                AND d.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="code != null">
                AND d.code = #{code}
            </if>
            <if test="doctorName != null">
                AND dd.name LIKE CONCAT('%', #{doctorName}, '%')
            </if>
            <if test="dcId != null">
                AND dc.id = #{dcId}
            </if>
            <if test="status != null">
                AND d.status = #{status}
            </if>
        </where>
    </select>

    <select id="getDepartmentSlimNameList" resultType="com.hospital.hospitalserver.domain.dto.response.HospitalGetDepartmentRespDto">
        SELECT
        id AS departmentId,
        name
        FROM hospital.h_department_tb
    </select>
</mapper>